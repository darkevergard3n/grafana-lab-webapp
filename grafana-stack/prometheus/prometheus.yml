# =============================================================================
# PROMETHEUS CONFIGURATION
# =============================================================================
# This config tells Prometheus what to scrape and how often.
#
# LEARNING NOTES:
# - global: Default settings for all jobs
# - scrape_configs: List of targets to scrape
# - static_configs: Manually specified targets
# - relabel_configs: Modify labels before storing
#
# IMPORTANT: Update WEBAPP_VM_IP with your actual webapp VM IP address!
# =============================================================================

global:
  # How often to scrape targets
  scrape_interval: 15s
  
  # How often to evaluate rules
  evaluation_interval: 15s
  
  # Attach these labels to all metrics
  external_labels:
    environment: 'lab'
    cluster: 'grafana-lab'

# =============================================================================
# ALERTING CONFIGURATION
# =============================================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# =============================================================================
# RULE FILES
# =============================================================================
rule_files:
  - '/etc/prometheus/alert_rules.yml'

# =============================================================================
# SCRAPE CONFIGURATIONS
# =============================================================================
scrape_configs:

  # ---------------------------------------------------------------------------
  # PROMETHEUS SELF-MONITORING
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # ---------------------------------------------------------------------------
  # WEBAPP VM - MICROSERVICES
  # ---------------------------------------------------------------------------
  # IMPORTANT: Replace ${WEBAPP_VM_IP} with your webapp VM's IP address
  # Example: 192.168.1.100
  
  - job_name: 'order-service'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8001']
        labels:
          service: 'order-service'
          language: 'go'
    metrics_path: '/metrics'

  - job_name: 'inventory-service'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8002']
        labels:
          service: 'inventory-service'
          language: 'rust'
    metrics_path: '/metrics'

  - job_name: 'payment-service'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8003']
        labels:
          service: 'payment-service'
          language: 'python'
    metrics_path: '/metrics'

  - job_name: 'user-service'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8004']
        labels:
          service: 'user-service'
          language: 'java'
    metrics_path: '/metrics'

  - job_name: 'notification-service'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8005']
        labels:
          service: 'notification-service'
          language: 'nodejs'
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # WEBAPP VM - INFRASTRUCTURE EXPORTERS
  # ---------------------------------------------------------------------------
  
  - job_name: 'traefik'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8082']
        labels:
          service: 'traefik'
    metrics_path: '/metrics'

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:9100']
        labels:
          service: 'node-exporter'
          instance: 'webapp-vm'
    metrics_path: '/metrics'

  - job_name: 'cadvisor'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:8081']
        labels:
          service: 'cadvisor'
    metrics_path: '/metrics'

  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:9187']
        labels:
          service: 'postgres-exporter'
    metrics_path: '/metrics'

  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['${WEBAPP_VM_IP}:9121']
        labels:
          service: 'redis-exporter'
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # GRAFANA VM - LOCAL MONITORING
  # ---------------------------------------------------------------------------
  
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
    metrics_path: '/metrics'

  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
        labels:
          service: 'loki'
    metrics_path: '/metrics'

  - job_name: 'tempo'
    static_configs:
      - targets: ['tempo:3200']
        labels:
          service: 'tempo'
    metrics_path: '/metrics'

  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          service: 'alertmanager'
    metrics_path: '/metrics'
